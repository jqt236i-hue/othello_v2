# カードオセロ 公式ルールブック（統合版）

最終更新: 2026-02-11

このファイル `01-rulebook.md` は、ゲームルールと UI/演出仕様の一次情報です。
実装と差分が出た場合は、このファイルを先に更新してください。

## 0. 読み方（重要）

- ルールと挙動の一次情報: このファイル
- カード名/ID/コストの一次情報: `cards/catalog.json`
- 実装が変わって挙動が変わる場合は、このファイルと `cards/catalog.json` を同時更新する

---

## 1. ゲーム概要

- 8x8 盤のオセロに、カード効果と布石（チャージ）を加えた 2 人対戦ゲーム
- 勝敗は最終盤面の石数で決定（多い方が勝ち、同数は引き分け）

## 2. 基本用語

### 2.1 盤面状態

- `BLACK`（黒）
- `WHITE`（白）
- `EMPTY`（空）

### 2.2 合法手

通常時、石を置けるのは次を満たすマスのみ。

- 置くマスが `EMPTY`
- 8方向のどこかで「相手石が連続し、その先に自分石」が成立

### 2.3 反転

「石の色が変わる」処理を反転とする。

- 通常オセロの挟み反転
- カード効果による色変更

※ 破壊（消滅）は反転ではない。

### 2.4 破壊

石を `EMPTY` にする処理。チャージ加算の対象外。

### 2.5 パス

自分の合法手が 0 のとき、次を選べる。

- カード使用
- パス

カード使用後も合法手が 0 ならパスできる。
その時点で未解決の選択中カード効果は破棄され、次ターンに持ち越さない。
（消費したコスト/カード使用自体は戻らない）

### 2.6 詰み

両者が連続でパスした状態（Aパス→Bパス）。

---

## 3. 盤・初期状態

- 盤サイズ: 8x8
- 初期配置: 中央4マスは通常オセロ配置
- 手番: 黒先手 / 白後手

---

## 4. デッキ・手札・ドロー

### 4.1 デッキ構成

- 黒デッキ30枚、白デッキ30枚（共通デッキではない）
- 各デッキは試合開始時にシャッフル
- 各デッキは「全カード種類を最低1枚保証」+ 重複ありで30枚を構成

### 4.2 初期手札

- 黒白とも 0 枚（開始時ドローなし）

### 4.3 手札上限

- 手札上限は 5 枚
- 5枚時の通常ドローは失敗（そのドロー機会は消える）

### 4.4 ドロー頻度

- 各プレイヤーは「自分の手番開始時」に自分のデッキから1枚ドロー
- パスした手番も「手番1回」として扱う
- 二連投石ターンでもドローは1回のみ

### 4.5 山札枯渇

- 山札が空ならドロー失敗
- 再シャッフルはしない

---

## 5. 布石（チャージ）

### 5.1 範囲

- 0〜30
- 上限超過は 30 に丸める

### 5.2 加算ルール

- 反転枚数を、その反転を発生させた側に即時加算
- ターン開始時の継続効果による反転も同様
- 破壊は加算対象外

### 5.3 消費

- カード使用時にコスト分消費
- 不足時は使用不可

---

## 6. 保護ルール

### 6.1 短期保護（Protected）

- 反転不可
- 交換不可
- 破壊は可能
- 持続: 次の相手ターン終了まで

### 6.2 永続保護（PermaProtected）

- 反転不可
- 交換不可
- 破壊は可能
- 解除なし（破壊まで継続）

### 6.3 合法手との関係

保護石は反転列に含めない。
そのため、反転列途中に保護石がある方向は合法手判定に使えない。

### 6.4 完全保護（守る意志）

- 反転・交換・破壊・誘惑をすべて無効化
- 持続中のみ有効

---

## 7. ターン進行（固定順）

1. ターン開始処理（継続効果、期限更新など）
2. ドロー判定
3. カード使用（任意、配置前のみ、原則1ターン1枚）
4. 配置またはパス
5. 反転処理
6. 配置後処理
7. チャージ加算
8. 終了判定
9. 手番交代

### 7.1 ターン開始処理の順

複数マーカーがある場合、`createdSeq` 昇順で処理する。

- 爆弾と特殊石は同列で扱う
- ターン開始処理中に新規生成されたマーカーは、その同ターン開始では発動しない
- `createdSeq` 同値/欠損時は実装順

### 7.2 二連投石（DOUBLE_PLACE）

- 同一手番で最大2回配置
- ドローは1回
- 2回目も合法手のみ
- 1回目後に終了条件成立なら2回目なし

---

## 8. 終了条件

### 8.1 終了タイミング

- 配置・反転・効果処理がすべて終わった後に判定

### 8.2 終了条件

- 盤面が埋まる
- 両者連続パス

### 8.3 勝敗

- 黒白の石数比較
- 多い方が勝利、同数は引き分け

---

## 9. カード共通ルール

- 使用可能タイミング: 配置前
- 使用回数: 原則 1ターン1枚
- 選択型カードは `selectTarget` 完了で効果確定
- 合法手0でカードを使っても合法手が増えなければ、そのままパス可能
- パス時に未解決効果は破棄（持ち越しなし）

---

## 10. カード効果（実装準拠）

### 10.1 TREASURE_BOX（宝箱）

- コスト0
- 使用時、布石を 1/2/3 からランダムで即時獲得

### 10.2 FREE_PLACEMENT（自由の意志）

- 次の配置のみ、空きマスなら反転0でも配置可能

### 10.3 PROTECTED_NEXT_STONE（弱い意志）

- 次に置く石に短期保護を付与

### 10.4 SWAP_WITH_ENEMY（交換の意志）

- 相手の通常石1つを自分色に変換
- 対象は相手通常石のみ（特殊石/爆弾/保護石は対象外）

### 10.5 SACRIFICE_WILL（生贄の意志）

- 自分石を最大3回まで選択破壊
- 1回ごとに布石 +5
- 1回以上選んだ後は任意終了可

### 10.6 PERMA_PROTECT_NEXT_STONE（強い意志）

- 次に置く石に永続保護を付与

### 10.7 STRONG_WIND_WILL（強風の意志）

- 盤上の石1つを選択
- 上下左右のうち「最も長く移動できる方向」を優先して移動
- 同じ移動距離の候補が複数ある場合のみランダムで決定
- 実際に移動したマス数ぶん布石を獲得（1マスにつき+1）

### 10.8 TRAP_WILL（罠の意志）

- 自分石1つを罠石化（座標は相手に非公開）
- 次の相手ターン中のみ有効
- 相手が罠石を反転すると発動:
  - 相手布石を0にし、その値を自分へ加算（上限30）
  - 相手手札を左から最大3枚没収
  - 自分手札上限超過分は自分デッキへ送る
- 相手ターンで反転されなければ不発消滅
- 罠石が破壊された場合も不発終了

### 10.9 TEMPT_WILL（誘惑の意志）

- 相手の特殊石1つを自分の石にする
- 付帯状態（残ターン等）は維持
- この色変更は反転枚数に加算しない
- 完全保護中の石は対象外

### 10.10 CHAIN_WILL（連鎖の意志）

- カード使用ターンの配置で生じた一次反転を起点に、追加反転を行う
- 追加反転は「連鎖1 → 連鎖2」の最大2回まで
- 各連鎖で最大反転数方向を優先（同値はランダム）

### 10.11 REGEN_WILL（復活の意志）

- 次に置いた石が1回だけ再生能力を持つ
- 反転されると即時に元色へ戻る
- 戻った石を起点に成立する列を反転
- 破壊では発動しない

### 10.12 DESTROY_ONE_STONE（破壊神）

- 任意の石1つを破壊

### 10.13 TIME_BOMB（時限爆弾）

- 盤面上の自分の石を1つ選んで爆弾化
- 所有者ターン開始ごとにカウント減少、0で爆発
- 爆発は3x3破壊（チャージ対象外）
- 反転された爆弾石は通常石に戻る（爆弾解除）

### 10.14 ULTIMATE_REVERSE_DRAGON（究極反転龍）

- 次に置く石を龍化（アンカー）
- 配置時即時 + 所有者ターン開始時に周囲8マスを反転
- 持続は所有者ターン基準で5回
- アンカーは反転/交換不可、破壊は可能
- アンカー消失で効果終了

### 10.15 BREEDING_WILL（繁殖の意志）

- 次に置く石を繁殖石化（アンカー）
- 配置時即時に、アンカーの周囲8マスの空きへランダム1個生成
- 所有者ターン開始時は「前回生成した石」を起点に、周囲8マスの空きへランダム1個生成
- 前回生成した石の一部でも反転/消滅していた場合、次の生成起点をアンカーへ戻す
- 生成で挟める場合は通常反転（反転数は布石加算対象）
- 持続3ターン
- 繁殖石は反転/交換不可、破壊は可能

### 10.16 CROSS_BOMB（十字爆弾）

- 次に置く石を十字爆弾化
- 通常反転後に中心+縦横2マスを破壊

### 10.17 HYPERACTIVE_WILL（多動の意志）

- 次に置く石を多動石化
- 両者ターン開始時、周囲空きへ1マスランダム移動
- 空きがなければ消滅
- 移動後に挟めれば反転
- 反転/交換された時点で多動属性解除

### 10.18 SELL_CARD_WILL（売却の意志）

- 使用後に手札1枚を売却
- 売却カードのコスト分、布石獲得

### 10.19 PLUNDER_WILL（吸収の意志）

- この手での反転枚数ぶん、相手布石を吸収して自分へ加算

### 10.20 WORK_WILL（出稼ぎの意志）

- 次配置石をアンカー化
- 所有者ターン開始時に `1→2→4→8→16` の順で加算
- アンカー喪失（破壊・相手化）で終了

### 10.21 DOUBLE_PLACE（二連投石）

- コスト24
- そのターンのみ配置回数 +1（合計2回）

### 10.22 HEAVEN_BLESSING（天の恵み）

- ランダム候補5枚から1枚選んで手札に加える
- 未選択候補は消滅（捨て札に送らない）
- 手札上限で受け取れない場合は選択不可

### 10.23 CONDEMN_WILL（断罪の意志）

- 相手手札を公開し、1枚選んで破壊

### 10.24 GOLD_STONE（金の意志）

- 次配置の反転による布石獲得を4倍
- 配置石は配置直後に自壊（フェードアウト）

### 10.25 SILVER_STONE（銀の意志）

- 次配置の反転による布石獲得を3倍
- 配置石は配置直後に自壊（フェードアウト）

### 10.26 STEAL_CARD（転売の意志）

- この手の反転枚数ぶん相手手札からカードを奪って売却する
- 売却したカード1枚につき布石を2獲得

### 10.27 GUARD_WILL（守る意志）

- 自分石1つに完全保護を付与
- 持続3ターン（所有者ターン開始で減算）

### 10.28 ULTIMATE_DESTROY_GOD（究極破壊神）

- 次に置く石をUDG化（アンカー）
- 配置時即時 + 所有者ターン開始時に周囲8マス敵石を破壊
- 持続5ターン
- アンカーは反転/交換不可、破壊は可能
- アンカー消失で効果終了

### 10.29 ULTIMATE_HYPERACTIVE_GOD（究極多動神）

- 次に置く石を究極多動神化（アンカー）
- 両者ターン開始時に発動（所有者ターン限定ではない）
- 1ターンで「1マス移動」を2回連続実行する（2マス直線固定移動はしない）
- 各移動ステップ開始時、周囲8マスに空きが無ければ消滅し、周囲8マスの敵石を全て破壊
- 各移動ステップの着地後、挟める列があれば通常反転する（吹き飛ばしは行わない）
- 反転・破壊・誘惑は可能、交換は無効
- 反転された時点で究極多動神属性は解除

### 10.30 POSITION_SWAP_WILL（入替の意志）

- 盤面上の石2つを順に選択し、2つの位置を入れ替える
- 対象は通常石・特殊石・爆弾を含む全種類の石
- 1つ目と同じマスは2つ目に選べない
- 入替のみ行い、反転や破壊は発生しない

---

## 11. コスト色分け（UI）

カードUIの色分けは以下。

- cost 0: 白
- cost 1〜5: 灰
- cost 6〜10: 緑
- cost 11〜15: 青
- cost 16〜20: 紫
- cost 21以上: 金

※ カード一覧・最新コストは `cards/catalog.json` を一次情報とする。

---

## 12. UI/演出仕様（要点）

### 12.1 再生原則

- UI は `events[]` を順番どおりに再生
- 再生中の盤面DOM更新は Playback Engine のみ
- 不明イベントはアニメ無しで最終状態を反映して継続

### 12.2 フリップ仕様（Spec B）

- 先に最終見た目へ切替
- その後にフリップモーション
- 全フリップで統一

### 12.3 クロスフェード

誘惑/継承/復活など、物理反転に見せない変更は真クロスフェードを使う。

### 12.4 配置見た目

特殊石は配置直後から最終見た目を表示（遅延差し替え禁止）。

### 12.5 主要時間定数

- `FLIP_MS = 600`
- `PHASE_GAP_MS = 200`
- `TURN_TRANSITION_GAP_MS = 200`
- `FADE_IN_MS = 300`
- `FADE_OUT_MS = 500`
- `OVERLAY_CROSSFADE_MS = 600`
- `MOVE_MS = 300`

### 12.6 効果ログ

- 通常ログと分離
- 効果ログは「実際に発動した効果のみ」
- 各行は必ず `黒:` / `白:` プレフィックス付き
- 通常ログと重複表示しない
- リセット時にクリア

### 12.7 通常ログ

- 進行情報（ターン、ドロー、パス等）を表示
- 配置反転は `黒がX枚反転！` / `白がX枚反転！` 形式
- 内部文言（`PresentationEvent` 等）は表示禁止

### 12.8 布石差分表示

- 布石増減時に `布石+N` / `布石-N` を表示
- 1cm下からスライドイン
- 4秒表示 + 0.5秒フェードアウト
- 連続更新時はキューで順番再生（取りこぼし禁止）
- 同一更新内で複数増減が発生した場合も、増減ごとに個別表示

### 12.9 例外演出

- `CHAIN_WILL`: 一次反転→連鎖1→連鎖2 を順番に再生（同時再生しない）
- `REGEN_WILL`: 敵色への一時フリップを省略しクロスフェード優先
- `TIME_BOMB`: 爆弾本体→周囲破壊の順
- `DOUBLE_PLACE`: 1回目完了後に2回目。間に開始時効果を再実行しない
- `POSITION_SWAP_WILL`: 入替の移動演出時間は通常移動の80%（20%短縮）
- `TRAP_WILL`: 設置者のみ罠見た目確認可、相手には通常石見た目

### 12.10 繁殖生成石UI

- 繁殖でそのターンに新規生成された石は、次の同一所有者ターン開始まで「小さめ + 草デザイン」で表示
- 草デザインは石の中心付近に、双葉マーク（草アイコン）で出す
- 草デザインは反転時に即消去
- カウント数字UIは表示しない

### 12.11 低アスペクト比時のレイアウト

- 本作の画面設計は横画面プレイを前提とし、縦画面レイアウトはサポート対象外とする
- サポート対象の画面比率は `16:9` / `16:10` / `3:2` / `4:3` / `5:4`（いずれも横画面）とする
- 画面比率が `4:3` 以下では、盤面を優先して周辺UIを縮小・再配置する
- 効果ログと通常ログは盤面と重ならない配置を優先する
- キャラクター画像は角寄せ配置 + 可変サイズにし、盤面の視認性を優先する
- ローカル確認用に `?simAspect=16:10` / `?simAspect=3:2` / `?simAspect=4:3` / `?simAspect=5:4` を付けると、実画面比率に関係なく指定比率向け配置を強制できる

### 12.12 カード詳細パネル

- カード選択時の説明本文は、まず短い効果要約を表示する
- `使用` ボタンの右に `詳細` ボタンを配置する
- `詳細` ボタン押下で要約された詳細効果を開閉表示する（再押下で閉じる）
- `売却選択` / `候補選択` 中は `使用` と `詳細` を非表示にし、操作干渉を避ける

---

## 13. 更新チェック

- 実装で挙動が変わったら本書を更新
- 本書に書かれていない新仕様は、実装前に本書へ追記
- `cards/catalog.json` とカード情報が食い違う場合は `cards/catalog.json` を正とし、本書を合わせる

---

## 14. CPU 思考仕様（実装運用）

### 14.1 モデル利用の前提

- CPU は学習モデル読込時のみ学習スコアを使う
- 学習モデルは `ONNX` を優先し、未読込・破損・版不一致時は `policy_table` を試す
- `ONNX` / `policy_table` の両方が使えない場合は既存思考へ即時フォールバックする
- フォールバック時も対戦は継続する

### 14.2 手の選び方（学習モデル有効時）

- まず「局面一致（完全一致）」を参照する
- 完全一致がない場合は「抽象局面」を参照する
- 抽象局面では、置き手を `corner / edge / inner / c / x` の分類で比較する
- 同点時は固定順で決める（再現性を保つ）

### 14.3 パス判定

- パス可否は、ターン開始効果を反映した後の合法手に基づいて判定する
- 不正パスが拒否された場合は、再決定して継続する

