# カードオセロ — Copilot / AI 作業ガイド（強制）

このリポジトリでの変更は、まず「一次情報（仕様）」と「境界（依存方向）」を守ること。
迷ったら、既存の実装パターンを検索して合わせ、差分最小で直す。

## 運用上の制約（重要）

- **ローカル完結:** できる限り、このPC内だけで完結させる（外部サービスに頼る手順は最小限）。
- **専門用語禁止:** 原則として専門用語・略語は使わない。どうしても必要なら、その場で一般向けに言い換え/短く説明する。
- **固有名詞を避ける:** 特定のサービス名・機能名で指示しない（一般名詞で書く）。
- **外部サービスは事前合意:** 外部サービスの利用や新しい外部依存の追加が必要なら、先にチーム合意を取る。
- **ローカル完結（強調）:** 外部のコード保管先へ変更を送信しない。文書、コミットメッセージ、テスト名、コードコメントなどで外部サービス由来の固有名詞・用語を使わない。
- **提案の言い回し（強制）:** 外部へ送信したり外部で確認したりする前提の提案はしない。必要なら『ローカルで差分を出しますか』『ローカルで確認ログを出しますか』のように言い換える。

### ローカル完結（厳禁）

- **厳禁（提案）:** 外部のコード保管先での作業（外部レビュー依頼、外部への反映、外部での確認）を前提にした提案をしない。
- **厳禁（言及）:** 外部のやり方（例: 外部レビュー、外部での統合、同期、公開）に話を寄せない。ローカルだけの手順だけを書く。
- **厳禁（用語）:** 「PR」「プルリク」など外部レビュー運用の言い回しを出さない。
- **厳禁（操作）:** 外部へ送受信が発生する操作やコマンド（例: `push` / `pull` / `fetch` / `clone` / `sync` / 外部への発行）を提案しない。
- **許可（ローカル）:** ローカルの差分作成、ローカルの履歴確認、ローカルのテスト実行、ローカルのビルド/実行、ローカルのログ出力は提案してよい。
- **言い換え:** 「外部へ出す」代わりに「ローカルで差分を作る/見る」「ローカルで確認ログを出す」「ローカルで手順を再現する」を使う。

## 自走モード（バイブコーディング向け）

このリポジトリで AI エージェントに期待するのは「確認待ち」ではなく「自律実行」です。
ただし、下記は **運用上の制約 / 一次情報 / 境界（依存方向）** を最優先で守った上で行います。

- **基本方針:** 目的が分かる限り、質問で止まらずに実装・検証まで進める。
- **不明点の扱い（デフォルト）:** 仕様・既存パターン・テスト・周辺コードから妥当な仮定を置き、差分最小で進める。
- **質問する条件（最小化）:** 次のいずれかに該当する場合のみ質問する。
  - 仕様（一次情報）と実装が矛盾していて、どちらを正にすべきか決められない
  - 破壊的変更（公開 API 変更、データ形式変更、大規模削除）が必要
  - 外部サービスや外部依存の導入が必要（事前合意が必要）
  - UI/演出などで「好み」の選択が本質で、正解が 1 つに定まらない
- **作業の進め方（自走）:**
  - 影響範囲（関連ファイル / テスト / チェック）を短く列挙したら、そのまま実装へ進む
  - 変更後は可能な範囲でテスト/チェックまで回して、落ちたら自分の変更に起因する範囲を優先的に直す
  - 無関係なリファクタリングや整形の波及は避け、依存方向と演出仕様を壊さない
- **完了の定義:** 目的が満たされ、関連テストが通り、差分が説明可能である（何を・どこを・なぜ変えたか）。

## 原因調査と修正の強制ルール

- **根本原因優先:** まず原因を特定する。症状を隠すだけの回避策を先に入れない。
- **証拠必須:** 修正前に再現手順と観測結果（最小ログまたはテスト）を残す。修正後は同条件で改善を確認する。
- **仕様不変:** UI/演出の一貫した仕様を崩す変更は原則禁止。必要な場合は変更理由と影響範囲を明記する。
- **境界で正規化:** `owner` / `player` / 色などの入力値は境界で正規化し、内部表現を統一する。
- **暫定対応の管理:** 暫定修正を入れる場合は、暫定であること・解除条件・追跡先を必ず記録する。

## 一次情報（ソース・オブ・トゥルース）

- ルール/カード仕様/UI・演出仕様の一次情報: `01-rulebook.md`
  - **Visual / UI / Animation Spec**（`# 03-visual-rulebook.v2`）も同ファイル内が一次情報。
- カード定義の一次情報: `cards/catalog.json`（ミラー: `cards/catalog.js`）
  - 片方だけ更新して乖離させない。
- 定数の一次情報: `shared-constants.js` と `constants/`
  - 同じ意味の値を別ファイルへ複製しない。

## モジュール境界（必須）

- `game/` は `ui/` に依存しない（`ui/` を import/参照しない）。UI 依存が必要なら DI 経由にする。
- `ui/` は `game/` の公開 API / イベント / DI だけを使い、内部実装に依存しない。
- `cpu/` は `game/` の読み取り専用 API を使い、副作用を持たない（DOM/UI/音/タイマー操作は禁止）。
- 起動順の唯一の入口は `index.html` に集約する（入口を増やさない）。
- 境界が崩れていないか、変更前後で短く確認する（game/ と ui/ を直接またがない）。

## UI/演出（特に重要）

- UI は `events[]` を **順番通りに再生**する。状態差分から「たぶんこう」を推測して補完しない（`01-rulebook.md` の Visual Spec 準拠）。
- 再生中に盤面 DOM を書き換える “書き手” は **1 つ**に限定する（Playback Engine 以外で触らない）。
- フリップは **Spec B**: 「見た目（色/特殊見た目）を先に最終状態へ」→「フリップモーション」。
- 演出の集約先:
  - アニメーション/演出: `ui/animation-*`, `ui/stone-visuals.js`
  - UI 実装の注入（DI）: `ui/bootstrap.js`（`__uiImpl_*` の出口を増やし過ぎない）

## デバッグ/診断

- 本番動作に影響する debug は `?debug=1` 等で **明示的に ON** にした時だけ動かす。
- 常時稼働の `setInterval` は原則禁止（必要なら debug 時のみ有効化）。
- `window`/`globalThis` への新規公開は最小限。追加するなら「公開理由」と「参照先」を近くに明記する。

## 変更の進め方（推奨手順）

- 仕様変更（ルール/カード効果/UI演出）なら:
  1) `01-rulebook.md` を先に更新
  2) テスト追加/更新
  3) 実装
- 影響範囲（関連ファイル/テスト/チェック）を先に列挙してから着手する。
- コピペ分岐を増やさず、既存の共通経路を再利用する（差分最小）。

## 仕様書更新の必須ルール（強制）

- 仕様変更だけでなく、**実装変更によって実際の挙動が変わる場合**は `01-rulebook.md` を必ず更新する。
- 実装差分があるのに `01-rulebook.md` 更新がない場合、そのタスクは未完了として扱う。
- `01-rulebook.md` の更新が不要だと判断した場合は、最終報告に不要理由を明記する。
- 最終報告には、`01-rulebook.md` の更新有無と更新箇所（見出し名または行）を必ず記載する。

## テスト/自動チェック（変更後に回す）

- まず: `npm test`
- 変更範囲が狭い場合: `npm run test:jest:changed`

## フォルダ別の追加指示

`.github/instructions/*.instructions.md` の `applyTo` ルールを必ず守る（`game/`, `ui/`, `cpu/`, `cards/`, `constants/`, `debug/`）。

## 役割の補足（迷ったときの配置）

- カード効果ロジックは `game/logic/cards.js` に置く（`cards/` はカード UI 側）。
- `cpu/` は旧構成のため、新規の決定ロジックは `game/cpu-decision.js` に寄せる。
